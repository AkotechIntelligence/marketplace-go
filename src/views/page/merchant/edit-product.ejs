<div class="account-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="account-title">Edit Product</h1>
            <p class="account-subtitle">Update product details</p>
        </div>
    </div>
</div>

<% if (messages.error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= messages.error %>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
<% } %>

<% if (messages.success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= messages.success %>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
<% } %>

<div class="account-card">
    <form action="/merchant/products/<%= product.uuid %>/edit" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="merchantShopUuid">Shop *</label>
            <select class="form-control" id="merchantShopUuid" name="merchantShopUuid" required>
                <option value="">Select a shop</option>
                <% shops.forEach(shop => { %>
                    <option value="<%= shop.uuid %>" 
                            <%= shop.uuid === product.merchantShopUuid ? 'selected' : '' %>>
                        <%= shop.shopName %>
                    </option>
                <% }); %>
            </select>
        </div>

        <div class="form-group">
            <label for="name">Product Name *</label>
            <input type="text" 
                   class="form-control" 
                   id="name" 
                   name="name" 
                   value="<%= product.name %>"
                   required>
        </div>

        <div class="form-group">
            <label for="description">Description *</label>
            <textarea class="form-control" 
                      id="description" 
                      name="description" 
                      rows="3" 
                      required><%= product.description %></textarea>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="price">Price *</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">$</span>
                        </div>
                        <input type="number" 
                               class="form-control" 
                               id="price" 
                               name="price" 
                               value="<%= product.price %>"
                               step="0.01" 
                               required>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="quantity">Quantity *</label>
                    <input type="number" 
                           class="form-control" 
                           id="quantity" 
                           name="quantity" 
                           value="<%= product.quantity %>"
                           required>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="categoryUuid">Category *</label>
                    <select class="form-control" id="categoryUuid" name="categoryUuid" required>
                        <option value="">Select a category</option>
                        <% categories.forEach(category => { %>
                            <option value="<%= category.uuid %>"
                                    <%= category.uuid === product.categoryUuid ? 'selected' : '' %>>
                                <%= category.name %>
                            </option>
                        <% }); %>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="subCategoryUuid">Sub Category *</label>
                    <select class="form-control" 
                            id="subCategoryUuid" 
                            name="subCategoryUuid" 
                            required>
                        <option value="">Select a category first</option>
                        <!-- Populate subcategories based on selected category -->
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Current Product Images</label>
            <div class="current-images mb-3 d-flex flex-wrap gap-3">
                <% if (product.ProductImages && product.ProductImages.length > 0) { %>
                    <% product.ProductImages.forEach(image => { %>
                        <div class="product-image-item">
                            <img src="/uploads/<%= image.imageUrl %>" 
                                 alt="Product image"
                                 class="img-thumbnail"
                                 style="width: 150px; height: 150px; object-fit: cover;">
                            <button type="button" 
                                    class="btn btn-sm btn-danger mt-2"
                                    onclick="deleteProductImage('<%= image.uuid %>')">
                                Remove
                            </button>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="text-muted">No images uploaded</p>
                <% } %>
            </div>
            
            <label>Add New Images</label>
            <div class="custom-file">
                <input type="file" 
                       class="custom-file-input" 
                       id="files" 
                       name="files" 
                       multiple 
                       accept="image/*">
                <label class="custom-file-label" for="files">
                    Choose files
                </label>
            </div>
            <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-3"></div>
        </div>

        <div class="form-group">
            <label>Product Fields</label>
            <div id="productFields">
                <% product.ProductFields.forEach(field => { %>
                    <div class="field-item">
                        <span><%= field.fieldLabel %> - <%= field.fieldType %></span>
                        <button type="button" class="btn btn-sm btn-warning" onclick="editProductField('<%= field.uuid %>')">Edit</button>
                    </div>
                <% }); %>
            </div>
            <button type="button" class="btn btn-primary" onclick="openFieldModal()">Add Field</button>
        </div>

        <div class="form-group">
            <label>Product Options</label>
            <div id="productOptions">
                <% product.ProductOptions.forEach(option => { %>
                    <div class="option-item">
                        <span><%= option.optionName %> - $<%= option.price %></span>
                        <button type="button" class="btn btn-sm btn-warning" onclick="editProductOption('<%= option.uuid %>')">Edit</button>
                    </div>
                <% }); %>
            </div>
            <button type="button" class="btn btn-primary" onclick="openOptionModal()">Add Option</button>
        </div>

        <div class="form-group mt-4">
            <button type="submit" class="btn btn-primary">Update Product</button>
            <a href="/merchant/products" class="btn btn-outline-secondary ml-2">Cancel</a>
        </div>
    </form>
</div>

<script src="/js/edit-product.js"></script>



<style>
.product-image-item {
    position: relative;
    margin-right: 1rem;
    margin-bottom: 1rem;
}

.gap-3 {
    gap: 1rem;
}
</style>